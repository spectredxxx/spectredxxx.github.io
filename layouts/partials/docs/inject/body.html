<div id="music-player" class="music-player">
    <audio id="bgm-audio" loop>
        <source src="/music/bgm.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>
    <button id="music-toggle" class="music-btn" title="播放/暂停背景音乐">
        <svg id="music-icon-play" viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2"
            fill="none" stroke-linecap="round" stroke-linejoin="round" class="feather feather-music">
            <path d="M9 18V5l12-2v13"></path>
            <circle cx="6" cy="18" r="3"></circle>
            <circle cx="18" cy="16" r="3"></circle>
        </svg>
        <svg id="music-icon-pause" viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2"
            fill="none" stroke-linecap="round" stroke-linejoin="round" class="feather feather-pause"
            style="display: none;">
            <rect x="6" y="4" width="4" height="16"></rect>
            <rect x="14" y="4" width="4" height="16"></rect>
        </svg>
    </button>
</div>

<!-- 引入 Swup 实现无刷新页面切换，保持音乐播放 -->
<script src="https://unpkg.com/swup@4"></script>
<script src="https://unpkg.com/@swup/body-class-plugin@3"></script>

<script>
    // 初始化 Swup
    // 确保 DOM 已经加载（或者脚本放在 body 底部）
    window.swup = new Swup({
        containers: ["main"], // 只替换 main 内容，保留 body 其他部分（如音乐播放器）
        plugins: [new SwupBodyClassPlugin()] // 自动更新 Body 的 class，保证 CSS 样式正确切换
    });

    document.addEventListener('DOMContentLoaded', function () {
        var audio = document.getElementById('bgm-audio');
        var btn = document.getElementById('music-toggle');
        var playIcon = document.getElementById('music-icon-play');
        var pauseIcon = document.getElementById('music-icon-pause');

        // 尝试恢复之前的播放状态（简单的 SessionStorage 实现）
        // 注意：浏览器通常阻止自动播放，所以这可能需要用户交互一次后才生效，
        // 或者我们默认设为暂停，让用户自己点。这里我们默认暂停。

        var isPlaying = false;

        btn.addEventListener('click', function () {
            if (isPlaying) {
                audio.pause();
                isPlaying = false;
                playIcon.style.display = 'block';
                pauseIcon.style.display = 'none';
                btn.classList.remove('playing');
            } else {
                var playPromise = audio.play();
                if (playPromise !== undefined) {
                    playPromise.then(function () {
                        isPlaying = true;
                        playIcon.style.display = 'none';
                        pauseIcon.style.display = 'block';
                        btn.classList.add('playing');
                    }).catch(function (error) {
                        console.log("Play failed:", error);
                    });
                }
            }
        });

        // 稍微调低点音量，不要太吵
        audio.volume = 0.4;
    });

    /* 
     * 自动生成收藏页 (Links) 的目录 (TOC)
     * 因为收藏页的标题是由 Shortcode 生成的 HTML，Hugo 默认的 TOC 无法识别。
     * 这里使用 JS 动态扫描 .links-category-title 并注入到侧边栏目录中。
     */
    /* 
     * 自动生成收藏页 (Links) 的目录 (TOC)
     * 兼容 Swup 页面切换和 Hugo Book 主题结构
     */
    function generateLinkTOC() {
        // 1. 找到所有由 links shortcode 生成的分类标题
        const headers = document.querySelectorAll('.links-category-title');
        if (headers.length === 0) return;

        console.log("Found " + headers.length + " headers, generating TOC...");

        // 2. 尝试找到 .book-toc 容器
        let aside = document.querySelector('.book-toc');

        // 如果容器不存在（因为 Markdown 没有原生标题，Hugo 可能没渲染它），我们需要手动创建
        if (!aside) {
            const mainContainer = document.querySelector('main.container');
            if (mainContainer) {
                aside = document.createElement('aside');
                aside.className = 'book-toc'; // 保持主题样式类名

                const contentDiv = document.createElement('div');
                contentDiv.className = 'book-toc-content';
                aside.appendChild(contentDiv);

                // 将侧边栏插入到 main 容器的最后（通常位于 .book-page 之后）
                mainContainer.appendChild(aside);
            }
        }

        if (!aside) return;

        // 3. 找到或创建 nav 元素
        let nav = aside.querySelector('nav');
        if (!nav) {
            nav = document.createElement('nav');
            nav.id = 'TableOfContents'; // Hugo 默认 TOC ID

            // 确保插在 .book-toc-content 里面
            const contentDiv = aside.querySelector('.book-toc-content') || aside;
            contentDiv.appendChild(nav);
        }

        // 清空现有内容（防止重复和脏数据）
        nav.innerHTML = '';

        // 4. 生成目录列表
        const ul = document.createElement('ul');

        headers.forEach(header => {
            // 确保每个标题都有 ID，作为锚点
            if (!header.id) {
                header.id = header.innerText.trim().toLowerCase().replace(/\s+/g, '-');
            }

            const li = document.createElement('li');
            const a = document.createElement('a');
            a.href = '#' + header.id;
            a.textContent = header.innerText;

            li.appendChild(a);
            ul.appendChild(li);
        });

        nav.appendChild(ul);
    }

    // 初始化运行
    document.addEventListener('DOMContentLoaded', generateLinkTOC);

    // 兼容 Swup：每次页面内容替换后重新运行
    if (window.swup) {
        window.swup.hooks.on('content:replace', generateLinkTOC);
    }
</script>